app-id: no.mifi.losslesscut
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node14

command: /app/bin/run.sh
finish-args:
  - --socket=x11
  - --share=ipc
  - --device=dri         # Without DRI the app doesn't come up :-/
  - --socket=pulseaudio  # We want to play sound, I suppose
  # Electron cannot do portals :(
  - --filesystem=xdg-download
  - --filesystem=xdg-public-share
  - --filesystem=xdg-videos
  - --talk-name=org.freedesktop.Notifications

modules:
  - name: yarn
    buildsystem: simple
    build-commands:
      - cp -a * /app
    # Only used for building, so clean it up afterwards.
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/yarnpkg/yarn/releases/download/v1.19.1/yarn-v1.19.1.tar.gz
        sha256: 34293da6266f2aae9690d59c2d764056053ff7eebc56b80b8df05010c3da9343

  - name: lossless-cut
    buildsystem: simple
    run-tests: true
    build-options:
      append-path: /usr/lib/sdk/node14/bin
      env:
        NPM_CONFIG_LOGLEVEL: info
        npm_config_nodedir: /usr/lib/sdk/node14

        # Tell caches where we pre-downloaded things.
        npm_config_cache: /run/build/lossless-cut/flatpak-node/npm-cache/
        electron_config_cache: /run/build/lossless-cut/flatpak-node/electron-cache

        # Tell the chromedriver npm package where we pre-downloaded things.
        ELECTRON_CACHE: /run/build/lossless-cut/flatpak-node/electron-cache

    modules:
      - ffmpeg.yaml
      - name: libvips
        buildsystem: meson
        sources:
          - type: archive
            url: https://github.com/libvips/libvips/releases/download/v8.14.1/vips-8.14.1.tar.xz
            sha256: 5abde2a61f99ced7be4c32ccb13a654256eb7a0f6f0520ab61cc11412a1233fa
            x-checker-data:
              type: json
              url: https://api.github.com/repos/libvips/libvips/releases/latest
              version-query: .tag_name | sub("^v"; "")
              url-query: .assets[] | select(.name=="vips-" + $version + ".tar.xz")
                | .browser_download_url
    build-commands:
      - node --version
      - yarn --version
      - env TMPDIR=$FLATPAK_BUILDER_BUILDDIR/flatpak-node/tmp HOME=$PWD yarn config
        --offline set yarn-offline-mirror $FLATPAK_BUILDER_BUILDDIR/flatpak-node/yarn-mirror
      - yarn --offline

      # it seems to expect the file in ffmpeg/linux-x64/ffmpeg (or -arm64), but how do I determine the architecture?
      - install -Dm a+rx /app/bin/ffmpeg  ./ffmpeg/linux/ffmpeg
      - install -Dm a+rx /app/bin/ffprobe  ./ffmpeg/linux/ffprobe
      - yarn --offline run pack-linux dir
      - mkdir -p /app/lossless-cut
      - cp -ar dist/linux-*unpacked/* /app/lossless-cut/

      # Install the required static files
      - install run.sh /app/bin/run.sh
      - desktop-file-edit --set-key Exec --set-value /app/bin/run.sh  no.mifi.losslesscut.desktop
      - install -Dm 0644 no.mifi.losslesscut.desktop  /app/share/applications/no.mifi.losslesscut.desktop
      - install -Dm 0644 no.mifi.losslesscut.appdata.xml  /app/share/metainfo/no.mifi.losslesscut.appdata.xml
      - install -Dm 0644 src/icon.svg /app/share/icons/hicolor/scalable/apps/no.mifi.losslesscut.svg

      # This is after the fact, and should probably be replaced by having put the files in the right place before electron-builder kicks in
      - install -Dm a+rx /app/bin/ffmpeg  /app/lossless-cut/resources/ffmpeg
      - install -Dm a+rx /app/bin/ffprobe  /app/lossless-cut/resources/ffprobe

    test-commands:
      - arch
      - /app/lossless-cut/resources/ffmpeg -version
      # This is what the app would call. Let's try it ourselves to see whether we're good.
      - /app/lossless-cut/resources/ffmpeg '-hide_banner' '-f' 'lavfi' '-i' 'nullsrc=s=256x256:d=1'
        '-f' 'null' '-'

    sources:
      # The chromedriver package tries to download a bunch of files
      # outside of the normal npm dependencies.  Pre-download them and
      # use ELECTRON_CACHE to point to them.
      # Taken from https://github.com/electron/chromedriver/issues/28#issuecomment-42783936
      - type: file
        only-arches: [x86_64]
        url: https://github.com/electron/electron/releases/download/v4.0.0/chromedriver-v4.0.0-linux-x64.zip
        sha256: 221db18ea2f3a8267f9a57ee61a9d5a6df09824c61bf8cefa360502cae503d7c
        dest: flatpak-node/electron-cache

      - type: file
        only-arches: [aarch64]
        url: https://github.com/electron/electron/releases/download/v4.0.0/chromedriver-v4.0.0-linux-arm64.zip
        sha256: 836f2484a35a1ed8e0467951920a0e33b597a4a073c278f5d6cf3abdb7f62df7
        dest: flatpak-node/electron-cache

      - type: file
        url: https://github.com/electron/electron/releases/download/v4.0.0/SHASUMS256.txt
        sha256: 52dfb903bf248db3b2c94cdcddd310034cd743098c13b5b10c71272ad6f812d1
        dest-filename: SHASUMS256.txt-4.0.0
        dest: flatpak-node/electron-cache

      - type: archive
        url: https://github.com/mifi/lossless-cut/archive/v3.45.0.tar.gz
        sha256: 4c71819f5506be8e84f9466fe2f00deb82a1f91e9d3b938636d7ea92a089226c

      - type: script
        dest-filename: run.sh
        commands:
          - /app/lossless-cut/losslesscut --no-sandbox

      #- type: file
      #  dest: static
      #  path: no.mifi.losslesscut.appdata.xml

      - generated-sources.0.json

      - type: patch
        paths:
          - no-asar.patch

